name: Auto-Deploy to Portainer

on:
  push:
    branches:
      - main  # Trigger deployment when there's a push to the 'main' branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Trigger stack redeploy
      run: |
        curl -X PUT "${{ secrets.PORTAINER_URL }}/api/stacks/${{ secrets.STACK_ID }}/git/redeploy?endpointId=${{ secrets.ENDPOINT_ID }}" \
          -H "X-API-Key:${{ secrets.PORTAINER_API_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{
            "Env": [
              { "name": "PG_USER", "value": "'"${{ secrets.PG_USER }}"'" },
              { "name": "PG_PASSWORD", "value": "'"${{ secrets.PG_PASSWORD }}"'" },
              { "name": "PG_HOST", "value": "'"${{ secrets.PG_HOST }}"'" },
              { "name": "DISCORD_TOKEN", "value": "'"${{ secrets.DISCORD_TOKEN }}"'" }
            ],
            "pullImage":true
          }'
          
